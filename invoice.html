<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice - Deyaar Makkah Bangladesh</title>
  <style>
    :root { 
      --bg:#0a0e1a; 
      --card:#1a1f35; 
      --muted:#94a3b8; 
      --text:#f1f5f9; 
      --accent:#f59e0b;
      --secondary:#8b5cf6;
      --border:#334155; 
      --shadow:0 20px 50px rgba(0,0,0,.5);
      --gold:#d4af37;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e1b4b 100%);
      color:var(--text);
      min-height:100vh;
    }

    .brandbar{
      width:100%;
      background: linear-gradient(135deg, #991b1b 0%, #b91c1c 25%, #dc2626 50%, #b91c1c 75%, #991b1b 100%);
      color:#fff;
      border-bottom: 2px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 8px 32px rgba(185, 28, 28, 0.4);
    }
    .brandwrap{
      max-width:1200px;
      margin:0 auto;
      padding:24px 24px 28px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:12px;
    }
    .brandlogo{
      width:80px;
      height:80px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:3px solid var(--gold);
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.25), rgba(255, 255, 255, 0.15));
      font-weight:900;
      font-size:28px;
      letter-spacing:2px;
      color:var(--gold);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .brandtxt .name{
      font-weight:900;
      font-size:26px;
      letter-spacing:1px;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.4);
    }
    .brandtxt .sub{
      font-size:14px;
      opacity:.95;
      color:rgba(255,255,255,0.9);
    }

    .wrap{
      max-width:1200px;
      margin:32px auto 80px;
      padding:0 24px;
    }
    .card{
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(245, 158, 11, 0.03));
      border:2px solid var(--border);
      border-radius:20px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card .body{padding:40px}
    .head{
      display:flex;
      justify-content:space-between;
      align-items:start;
      gap:24px;
      flex-wrap:wrap;
      margin-bottom:32px;
      padding-bottom:24px;
      border-bottom:2px solid var(--border);
    }
    .brand{
      font-weight:800;
      letter-spacing:1px;
      font-size:28px;
      color:var(--accent);
    }
    .muted{color:var(--muted)}
    
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
    }
    th,td{
      text-align:left;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
    }
    th{
      color:var(--muted);
      font-weight:700;
      background:rgba(139, 92, 246, 0.05);
    }
    .right{text-align:right}
    .center{text-align:center}
    
    .info-table td{
      background:rgba(15, 23, 42, 0.5);
    }
    
    h3{
      margin:32px 0 16px;
      font-size:24px;
      color:var(--accent);
    }

    #roomsTable{
      background:rgba(15, 23, 42, 0.3);
      border-radius:12px;
      overflow:hidden;
    }
    #roomsTable thead th{
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(245, 158, 11, 0.15));
      color:var(--text);
      font-size:15px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    #roomsTable tbody td{
      font-size:15px;
      background:rgba(15, 23, 42, 0.4);
    }
    #roomsTable tbody tr:hover{
      background:rgba(139, 92, 246, 0.08);
    }
    
    #roomsTable tfoot{
      background:rgba(139, 92, 246, 0.1);
    }
    #roomsTable tfoot td,
    #roomsTable tfoot th{
      font-weight:700;
      font-size:16px;
      border-top:2px solid var(--border);
      border-bottom:0;
    }
    .subtotal-row td,
    .subtotal-row th{
      padding-top:16px;
    }
    .grand-total-row td,
    .grand-total-row th{
      font-weight:900;
      font-size:20px;
      color:var(--accent);
      padding-top:16px;
      padding-bottom:16px;
      border-top:3px solid var(--accent);
    }
    
    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:32px;
      justify-content:flex-end;
    }
    button, .btn-link{
      border:0;
      padding:14px 28px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:15px;
      transition: all 0.3s ease;
      text-decoration:none;
      display:inline-block;
    }
    button.success{
      background: linear-gradient(135deg, #10b981, #059669);
      color:#fff;
      box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);
    }
    button.success:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(16, 185, 129, 0.4);
    }
    .btn-link{
      background: linear-gradient(135deg, var(--secondary), #7c3aed);
      color:#fff;
      box-shadow:0 4px 12px rgba(139, 92, 246, 0.3);
    }
    .btn-link:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(139, 92, 246, 0.4);
    }
    
    .error{
      max-width:1200px;
      margin:32px auto;
      color:#fff;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      border:2px solid #991b1b;
      border-radius:16px;
      padding:20px 24px;
      box-shadow:0 8px 24px rgba(220, 38, 38, 0.3);
    }

    @page { 
      size: A4; 
      margin: 12mm; 
    }
    
    @media print {
      * { 
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      body {
        background: #fff !important;
        position: relative;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70%;
        height: 85%;
        opacity: 0.08;
        z-index: 0;
        background: 
          linear-gradient(135deg, rgba(139, 28, 32, 0.15) 0%, rgba(203, 45, 54, 0.15) 100%),
          url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 1000"><defs><linearGradient id="rg" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="%23991b1b"/><stop offset="1" stop-color="%23dc2626"/></linearGradient></defs><rect fill="url(%23rg)" width="800" height="280" rx="20"/><path fill="%23d4af37" d="M120 60h80v80h-80z" rx="12"/><text x="160" y="115" font-size="42" font-weight="900" fill="%23d4af37" text-anchor="middle">DMB</text><text x="400" y="140" font-size="48" font-weight="900" fill="white" text-anchor="middle">DEYAAR MAKKAH</text><text x="400" y="185" font-size="48" font-weight="900" fill="white" text-anchor="middle">BANGLADESH</text><text x="400" y="225" font-size="24" fill="rgba(255,255,255,0.9)" text-anchor="middle">Sylhet - Bangladesh</text><text x="400" y="920" font-size="52" font-weight="800" fill="%23991b1b" text-anchor="middle" opacity="0.7">Thank You for</text><text x="400" y="975" font-size="52" font-weight="800" fill="%23991b1b" text-anchor="middle" opacity="0.7">Your Payment!</text></svg>');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }
      
      .wrap, .card, .card .body {
        position: relative;
        z-index: 1;
        background: transparent !important;
      }
      
      .brandbar {
        background: linear-gradient(135deg, #8b1c20 0%, #991b1b 25%, #b91c1c 50%, #991b1b 75%, #8b1c20 100%) !important;
        border-bottom: 2px solid #d4af37 !important;
      }
      
      .brandlogo {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(255, 255, 255, 0.2)) !important;
        border: 3px solid #d4af37 !important;
        color: #d4af37 !important;
      }
      
      .brandtxt .name, .brandtxt .sub {
        color: #fff !important;
      }
      
      .card {
        border: 2px solid #333 !important;
        box-shadow: none !important;
      }
      
      .head {
        border-bottom: 2px solid #999 !important;
      }
      
      .brand {
        color: #000 !important;
      }
      
      .muted {
        color: #444 !important;
      }
      
      h3 {
        color: #000 !important;
      }
      
      table {
        border-collapse: collapse !important;
        page-break-inside: avoid;
      }
      
      th, td {
        border: 1px solid #666 !important;
        padding: 8px 12px !important;
        color: #000 !important;
        background: transparent !important;
      }
      
      th {
        background: rgba(245, 158, 11, 0.15) !important;
        font-weight: 800 !important;
      }
      
      #roomsTable tfoot td,
      #roomsTable tfoot th {
        border-top: 2px solid #000 !important;
      }
      
      .grand-total-row td,
      .grand-total-row th {
        font-weight: 900 !important;
        font-size: 16pt !important;
        border-top: 3px solid #000 !important;
        color: #000 !important;
      }
      
      .actions {
        display: none !important;
      }
      
      body {
        font-size: 10pt !important;
      }
    }
  </style>
</head>
<body>
  <div class="brandbar" role="banner">
    <div class="brandwrap">
      <div class="brandlogo">DMB</div>
      <div class="brandtxt">
        <div class="name">DEYAAR MAKKAH BANGLADESH</div>
        <div class="sub">Sylhet - Bangladesh</div>
      </div>
    </div>
  </div>

  <div id="error" class="error" style="display:none"></div>
  <div class="wrap">
    <section class="card">
      <div class="body">
        <div class="head">
          <div>
            <div class="brand" id="hotelBrand">Hotel</div>
            <div class="muted" id="hotelAddr">Address</div>
          </div>
          <div class="muted">Invoice Date: <span id="invDate"></span></div>
        </div>

        <table class="info-table">
          <tbody>
            <tr><th style="width:220px">Guest Name</th><td id="vGuestName"></td></tr>
            <tr><th>Guest Address</th><td id="vGuestAddress"></td></tr>
            <tr><th>Check-in</th><td id="vIn"></td></tr>
            <tr><th>Check-out</th><td id="vOut"></td></tr>
            <tr><th>Nights</th><td id="vNights"></td></tr>
          </tbody>
        </table>

        <h3>Rooms</h3>
        <table id="roomsTable">
          <thead>
            <tr>
              <th>Qty</th>
              <th>View</th>
              <th>Type</th>
              <th class="right">Rate (Tk)</th>
              <th>Meal Type</th>
              <th class="right">Meal Rate (Tk)</th>
              <th class="right">Line / Night (Tk)</th>
            </tr>
          </thead>
          <tbody id="roomsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="6" class="right">Room Rent Total (per night)</th>
              <td id="roomRentPerNight" class="right"></td>
            </tr>
            <tr>
              <th colspan="6" class="right">Meal Total (per night)</th>
              <td id="mealPerNight" class="right"></td>
            </tr>
            <tr>
              <th colspan="6" class="right">Total Per Night</th>
              <td id="totalPerNight" class="right"></td>
            </tr>
            <tr style="font-weight:800">
              <th colspan="6" class="right">Total (Nights × Total Per Night)</th>
              <td id="grandTotal" class="right"></td>
            </tr>
          </tfoot>
        </table>

        <div class="actions">
          <button id="btnPrint" class="success" type="button">Print / Save PDF</button>
          <a id="editLink" href="index.html" class="btn-link">Edit Details</a>
        </div>
      </div>
    </section>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const toLocal = d => new Date(d).toLocaleDateString(
    undefined, { year:'numeric', month:'short', day:'2-digit' }
  );
  const fmtTk = n => `${Number(n||0).toLocaleString()} Tk`;

  function showErr(msg){
    const e = $('#error');
    if (e){ e.style.display='block'; e.textContent = msg; } else { alert(msg); }
  }

  function loadFromQuery(){
    const p = new URLSearchParams(location.search);
    const get = k => (p.get(k)||'').trim();

    const hotelName    = get('hotelName');
    const hotelAddress = get('hotelAddress');
    const guestName    = get('guestName');
    const guestAddress = get('guestAddress');
    const ci           = get('checkin');
    const co           = get('checkout');
    const overallMeals = get('meals'); // fallback meal type if per-room not present

    let rooms = [];
    try { rooms = JSON.parse(p.get('rooms') || '[]'); } catch(e){ rooms = []; }

    if(!hotelName||!hotelAddress||!guestName||!guestAddress||!ci||!co||!rooms.length){
      return showErr('Missing details. Please go back and fill the form.');
    }
    const nights = Math.max(0, Math.round((new Date(co)-new Date(ci)) / (24*60*60*1000)));
    if (nights <= 0) return showErr('Check-out must be after Check-in.');

    // Fill header/meta
    $('#hotelBrand')   && ($('#hotelBrand').textContent   = hotelName);
    $('#hotelAddr')    && ($('#hotelAddr').textContent    = hotelAddress);
    $('#vGuestName')   && ($('#vGuestName').textContent   = guestName);
    $('#vGuestAddress')&& ($('#vGuestAddress').innerHTML  = guestAddress.replace(/\n/g,'<br>'));
    $('#vIn')          && ($('#vIn').textContent          = toLocal(ci));
    $('#vOut')         && ($('#vOut').textContent         = toLocal(co));
    $('#vNights')      && ($('#vNights').textContent      = `${nights} night${nights>1?'s':''}`);
    $('#invDate')      && ($('#invDate').textContent      = toLocal(new Date()));

    // Build detail rows
    const body = document.getElementById('roomsBody') || document.querySelector('#roomsTable tbody');
    if (body) body.innerHTML = '';

    let roomRentPerNight = 0; // Σ qty * rate
    let mealPerNight     = 0; // Σ qty * mealRate
    let totalPerNight    = 0; // Σ qty * (rate + mealRate)

    rooms.forEach(r => {
      const qty      = Number.isFinite(+r.qty)      ? +r.qty      : 0;
      const rate     = Number.isFinite(+r.rate)     ? +r.rate     : 0;
      const mealRate = Number.isFinite(+r.mealRate) ? +r.mealRate : 0;
      const mealType = (r.mealType && String(r.mealType).trim()) || overallMeals || 'None';
      const view     = r.roomView || '';
      const type     = r.roomType || '';

      const roomLine = qty * rate;
      const mealLine = qty * mealRate;
      const line     = roomLine + mealLine;

      roomRentPerNight += roomLine;
      mealPerNight     += mealLine;
      totalPerNight    += line;

      if (body){
        const tr = document.createElement('tr');
        const cells = [
          qty,                // Qty
          view,               // View
          type,               // Type
          fmtTk(rate),        // Rate (Tk)
          mealType,           // Meal Type
          fmtTk(mealRate),    // Meal Rate (Tk)
          fmtTk(line)         // Line / Night (Tk)
        ];
        cells.forEach((val, idx) => {
          const td = document.createElement('td');
          td.textContent = val;
          if (idx === 3 || idx === 5 || idx === 6) td.className = 'right';
          tr.appendChild(td);
        });
        body.appendChild(tr);
      }
    });

    // Footer totals
    $('#roomRentPerNight') && ($('#roomRentPerNight').textContent = fmtTk(roomRentPerNight));
    $('#mealPerNight')     && ($('#mealPerNight').textContent     = fmtTk(mealPerNight));
    $('#totalPerNight')    && ($('#totalPerNight').textContent    = fmtTk(totalPerNight));
    $('#grandTotal')       && ($('#grandTotal').textContent       = fmtTk(totalPerNight * nights));

    // Keep Edit Details round-trip intact
    $('#editLink') && ($('#editLink').href = `index.html?${p.toString()}`);
  }

  document.getElementById('btnPrint')?.addEventListener('click', () => window.print());
  loadFromQuery();
</script>

</body>
</html>